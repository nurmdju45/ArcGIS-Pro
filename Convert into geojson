import arcpy
import os
import json

# Set the workspace (folder containing your .shp files)
workspace = r"D:\ELTE MSc\3rd Semester\Project\WGS File"

# Set the output folder for GeoJSON files
output_folder = r"D:\ELTE MSc\3rd Semester\Project\Test GeoJSon"

# List all shapefiles in the directory
shp_files = [f for f in os.listdir(workspace) if f.endswith(".shp")]

# Iterate through the shapefiles and convert them to GeoJSON
for shp_file in shp_files:
    # Full path to the shapefile
    shp_path = os.path.join(workspace, shp_file)
    
    # Construct the output JSON file path
    json_file = os.path.splitext(shp_file)[0] + ".json"
    json_path = os.path.join(output_folder, json_file)
    
    try:
        # Convert to JSON (intermediate format)
        arcpy.conversion.FeaturesToJSON(shp_path, json_path)
        print(f"Successfully converted {shp_file} to {json_file}")

        # Now read the JSON and reformat it as GeoJSON
        with open(json_path, 'r', encoding='utf-8') as f:  # Specify UTF-8 encoding
            data = json.load(f)

        # Write the data to GeoJSON format
        geojson_file = os.path.splitext(shp_file)[0] + ".geojson"
        geojson_path = os.path.join(output_folder, geojson_file)

        # Check if the output data has the required structure for GeoJSON
        geojson_data = {
            "type": "FeatureCollection",
            "features": data['features']
        }

        with open(geojson_path, 'w', encoding='utf-8') as f:  # Specify UTF-8 encoding
            json.dump(geojson_data, f, indent=2)

        print(f"Successfully converted {shp_file} to {geojson_file}")
        
        # Remove the intermediate JSON file
        os.remove(json_path)

    except Exception as e:
        print(f"Error converting {shp_file}: {e}")
